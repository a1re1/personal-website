<html>
    <header>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    </header>
    <body>
        <script src="https://apis.google.com/js/api.js"></script>
        <script>
            const sleep = (milliseconds) => {
                return new Promise(resolve => setTimeout(resolve, milliseconds))
            }

            function linkify(inputText) {
                var replacedText, replacePattern1, replacePattern2, replacePattern3;

                //URLs starting with http://, https://
                replacePattern1 = /(\b(https?):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
                replacedText = inputText.replace(replacePattern1, '<a href="$1" target="_blank">$1</a>');

                //URLs starting with "www." (without // before it, or it'd re-link the ones done above).
                replacePattern2 = /(^|[^\/])(www\.[\S]+(\b|$))/gim;
                replacedText = replacedText.replace(replacePattern2, '$1<a href="http://$2" target="_blank">$2</a>');

                return replacedText;
            }

            window.onload = function authenticate() {
                sleep(100).then(() => {
                    if (!gapi.auth2.getAuthInstance().isSignedIn.get()){
                            gapi.auth2.getAuthInstance()
                            .signIn({scope: "https://www.googleapis.com/auth/calendar.readonly"})
                            .then(function() { console.log("Sign-in successful"); },
                                    function(err) { console.error("Error signing in", err); });
                    }

                    return gapi.client.load("https://content.googleapis.com/discovery/v1/apis/calendar/v3/rest")
                    .then(function() { console.log("GAPI client loaded for API"); },
                            function(err) { console.error("Error loading GAPI client for API", err); })
                });
                
                sleep(300).then(() => {
                    execute();
                });
            }

            function render(events) {
                    var table = document.createElement("table");

                    for (var i = 0; i < events.length; i++) {
                        var tr = table.insertRow(i);
                        var tCell = tr.insertCell(0);

                        var previewWrapper = document.createElement("div");
                        previewWrapper.id = "assignment";

                        var assignmentPreview = document.createElement("table");
                        previewWrapper.appendChild(assignmentPreview);

                        // Name
                        assignmentPreview.insertRow(0).insertCell(0)
                        .appendChild(document.createTextNode(events[i].summary));

                        // Date
                        assignmentPreview.insertRow(1).insertCell(0)
                        .appendChild(document.createTextNode(events[i].start.date));

                        // Desc
                        var linkifiedDesc = document.createElement("P");
                        linkifiedDesc.innerHTML = linkify(events[i].description);
                        assignmentPreview.insertRow(2).insertCell(0)
                        .appendChild(linkifiedDesc);

                        tCell.appendChild(previewWrapper);
                    }
                    
                    return table;
            }
            
            // Make sure the client is loaded and sign-in is complete before calling this method.
            function execute() {
                return gapi.client.calendar.events.list({
                "calendarId": "sf0n3mmqm9rbn2tmi9fm8bq2kg@group.calendar.google.com",
                "maxResults": 25
                })
                    .then(function(response) {
                            var doc = document.getElementById("assignments");
                            doc.innerHTML = "";
                            var tab = render(response.result.items);
                            console.log(tab);
                            doc.appendChild(tab);
                        },
                        function(err) { console.error("Execute error", err); });
            }
            
            gapi.load("client:auth2", function() {
                gapi.auth2.init({client_id: "781812892715-eotcsfcrsir16jkltigu0ft97d38j3fa.apps.googleusercontent.com"});
            });
        </script>

        <h2>
          Assignments
        </h2>

        <div id="assignments" onload="authenticate()">
            <button onclick="execute()">Load assignments</button></p>
        </div>
    </body>
</html>
